var rt=(g,y,E)=>{if(!y.has(g))throw TypeError("Cannot "+E)};var l=(g,y,E)=>(rt(g,y,"read from private field"),E?E.call(g):y.get(g)),D=(g,y,E)=>{if(y.has(g))throw TypeError("Cannot add the same private member more than once");y instanceof WeakSet?y.add(g):y.set(g,E)},b=(g,y,E,z)=>(rt(g,y,"write to private field"),z?z.call(g,E):y.set(g,E),E);var O=(g,y,E)=>(rt(g,y,"access private method"),E);(function(){var T,S,C,G,M,j,x,L,R,H,V,pt,v,mt,Y,wt,q,gt,W,it;"use strict";const g=Symbol("Comlink.proxy"),y=Symbol("Comlink.endpoint"),E=Symbol("Comlink.releaseProxy"),z=Symbol("Comlink.thrown"),ot=t=>typeof t=="object"&&t!==null||typeof t=="function",St={canHandle:t=>ot(t)&&t[g],serialize(t){const{port1:e,port2:s}=new MessageChannel;return J(t,e),[s,[s]]},deserialize(t){return t.start(),kt(t)}},yt={canHandle:t=>ot(t)&&z in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},lt=new Map([["proxy",St],["throw",yt]]);function J(t,e=self){e.addEventListener("message",function s(a){if(!a||!a.data)return;const{id:r,type:u,path:n}=Object.assign({path:[]},a.data),c=(a.data.argumentList||[]).map(B);let h;try{const i=n.slice(0,-1).reduce((d,m)=>d[m],t),f=n.reduce((d,m)=>d[m],t);switch(u){case"GET":h=f;break;case"SET":i[n.slice(-1)[0]]=B(a.data.value),h=!0;break;case"APPLY":h=f.apply(i,c);break;case"CONSTRUCT":{const d=new f(...c);h=bt(d)}break;case"ENDPOINT":{const{port1:d,port2:m}=new MessageChannel;J(t,m),h=Q(d,[d])}break;case"RELEASE":h=void 0;break;default:return}}catch(i){h={value:i,[z]:0}}Promise.resolve(h).catch(i=>({value:i,[z]:0})).then(i=>{const[f,d]=Z(i);e.postMessage(Object.assign(Object.assign({},f),{id:r}),d),u==="RELEASE"&&(e.removeEventListener("message",s),ct(e))})}),e.start&&e.start()}function Dt(t){return t.constructor.name==="MessagePort"}function ct(t){Dt(t)&&t.close()}function kt(t,e){return K(t,[],e)}function U(t){if(t)throw new Error("Proxy has been released and is not useable")}function K(t,e=[],s=function(){}){let a=!1;const r=new Proxy(s,{get(u,n){if(U(a),n===E)return()=>_(t,{type:"RELEASE",path:e.map(c=>c.toString())}).then(()=>{ct(t),a=!0});if(n==="then"){if(e.length===0)return{then:()=>r};const c=_(t,{type:"GET",path:e.map(h=>h.toString())}).then(B);return c.then.bind(c)}return K(t,[...e,n])},set(u,n,c){U(a);const[h,i]=Z(c);return _(t,{type:"SET",path:[...e,n].map(f=>f.toString()),value:h},i).then(B)},apply(u,n,c){U(a);const h=e[e.length-1];if(h===y)return _(t,{type:"ENDPOINT"}).then(B);if(h==="bind")return K(t,e.slice(0,-1));const[i,f]=ht(c);return _(t,{type:"APPLY",path:e.map(d=>d.toString()),argumentList:i},f).then(B)},construct(u,n){U(a);const[c,h]=ht(n);return _(t,{type:"CONSTRUCT",path:e.map(i=>i.toString()),argumentList:c},h).then(B)}});return r}function Et(t){return Array.prototype.concat.apply([],t)}function ht(t){const e=t.map(Z);return[e.map(s=>s[0]),Et(e.map(s=>s[1]))]}const ut=new WeakMap;function Q(t,e){return ut.set(t,e),t}function bt(t){return Object.assign(t,{[g]:!0})}function Z(t){for(const[e,s]of lt)if(s.canHandle(t)){const[a,r]=s.serialize(t);return[{type:"HANDLER",name:e,value:a},r]}return[{type:"RAW",value:t},ut.get(t)||[]]}function B(t){switch(t.type){case"HANDLER":return lt.get(t.name).deserialize(t.value);case"RAW":return t.value}}function _(t,e,s){return new Promise(a=>{const r=Tt();t.addEventListener("message",function u(n){!n.data||!n.data.id||n.data.id!==r||(t.removeEventListener("message",u),a(n.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:r},e),s)})}function Tt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function $(t,e,s){const a=[];for(let r=e;r<e+s;r++)a.push(t[r]);return a}const F={LITTLE:0,BIG:1};function It(t){const e=$(t,4,2);return e[0]===255&&e[1]===254?F.LITTLE:F.BIG}function At(t,e,s,a=F.BIG){const r=$(t,e,s);return a===F.LITTLE&&r.reverse(),String.fromCharCode(...r)}function o(t,e,s,a=F.BIG){const r=$(t,e,s);return a===F.LITTLE&&r.reverse(),r.reduce((u,n)=>u*256+n,0)}function tt(t,e,s){return t<=e?e:t>=s?s:t}function P(t){return t>=32768?t-65536:t}class Ct{constructor(e){D(this,V);D(this,v);D(this,Y);D(this,q);D(this,W);D(this,T,void 0);D(this,S,void 0);D(this,C,void 0);D(this,G,void 0);D(this,M,void 0);D(this,j,void 0);D(this,x,void 0);D(this,L,void 0);D(this,R,void 0);D(this,H,void 0);if(b(this,x,null),b(this,L,null),b(this,R,null),b(this,H,[]),this.rawData=new Uint8Array(e),At(this.rawData,0,4)!=="RSTM")throw new Error("Not a valid BRSTM file");this.endianness=It(this.rawData),b(this,T,o(this.rawData,16,4,this.endianness)),b(this,S,l(this,T)+o(this.rawData,l(this,T)+12,4,this.endianness)+8),b(this,C,l(this,T)+o(this.rawData,l(this,T)+20,4,this.endianness)+8),b(this,G,l(this,T)+o(this.rawData,l(this,T)+28,4,this.endianness)+8),b(this,M,o(this.rawData,24,4,this.endianness)),b(this,j,o(this.rawData,32,4,this.endianness)),this.metadata=O(this,v,mt).call(this)}getAllSamples(){if(l(this,x))return l(this,x);const{numberChannels:e,totalSamples:s,totalBlocks:a,samplesPerBlock:r}=this.metadata,u=[];for(let n=0;n<e;n++)u.push(new Int16Array(s));for(let n=0;n<a;n++){const c=O(this,W,it).call(this,n);for(let h=0;h<e;h++)u[h].set(c[h],n*r)}return b(this,x,u),u}getBuffer(e,s){return this.getSamples(e,s)}getSamples(e,s){const{numberChannels:a,totalBlocks:r,totalSamples:u,samplesPerBlock:n}=this.metadata,c=Math.max(0,e),h=Math.min(u,e+s),i=Math.max(0,Math.floor(c/n)),f=Math.min(r-1,Math.floor(h/n)),d=[];for(let w=i;w<=f;w++)d.push(O(this,W,it).call(this,w));const m=[];for(let w=0;w<a;w++)m.push(new Int16Array(h-c));for(let w=i;w<=f;w++){const I=w-i;if(w===i&&w===f)for(let p=0;p<a;p++)m[p].set(d[I][p].slice(c-i*n,c-i*n+s),0);else if(w===i)for(let p=0;p<a;p++){const k=d[I][p].slice(c-i*n);m[p].set(k,0)}else if(w===f)for(let p=0;p<a;p++){const k=d[I][p].slice(0,h-d[I][p].length-i*n);k.length+(w*n-c)>m[p].length?m[p].set(k.slice(0,s-(w*n-c)),w*n-c):m[p].set(k,w*n-c)}else for(let p=0;p<a;p++)m[p].set(d[I][p],w*n-c)}return m}}T=new WeakMap,S=new WeakMap,C=new WeakMap,G=new WeakMap,M=new WeakMap,j=new WeakMap,x=new WeakMap,L=new WeakMap,R=new WeakMap,H=new WeakMap,V=new WeakSet,pt=function(){if(l(this,R))return l(this,R);const{numberChannels:e}=this.metadata,s=[];for(let a=0;a<e;a++){const r=l(this,T)+o(this.rawData,l(this,G)+8+a*8,4,this.endianness)+8+8,u=[];for(let n=0;n<16;n++){const c=o(this.rawData,r+2*n,2,this.endianness);u.push(P(c))}s.push({adpcmCoefficients:u,gain:o(this.rawData,r+40,2,this.endianness),initialPredictorScale:o(this.rawData,r+42,2,this.endianness),historySample1:o(this.rawData,r+44,2,this.endianness),historySample2:o(this.rawData,r+46,2,this.endianness),loopPredictorScale:o(this.rawData,r+48,2,this.endianness),loopHistorySample1:o(this.rawData,r+50,2,this.endianness),loopHistorySample2:o(this.rawData,r+52,2,this.endianness)})}return b(this,R,s),s},v=new WeakSet,mt=function(){const e=o(this.rawData,l(this,S)+2,1,this.endianness),s=o(this.rawData,l(this,C),1,this.endianness),a=o(this.rawData,l(this,C)+1,1,this.endianness),r=[];for(let n=0;n<s;n++){const c=l(this,T)+8+o(this.rawData,l(this,C)+4+n*8+4,4,this.endianness),h=o(this.rawData,l(this,C)+4+n*8+1,1,this.endianness);let i=0;h===0?i=o(this.rawData,c,1,this.endianness):h===1&&(i=o(this.rawData,c+8,1,this.endianness)),r.push({numberChannels:i,type:h})}const u={fileSize:o(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:o(this.rawData,l(this,S),1,this.endianness),loopFlag:o(this.rawData,l(this,S)+1,1,this.endianness),numberChannels:e,sampleRate:o(this.rawData,l(this,S)+4,2,this.endianness),loopStartSample:o(this.rawData,l(this,S)+8,4,this.endianness),totalSamples:o(this.rawData,l(this,S)+12,4,this.endianness),totalBlocks:o(this.rawData,l(this,S)+20,4,this.endianness),blockSize:o(this.rawData,l(this,S)+24,4,this.endianness),samplesPerBlock:o(this.rawData,l(this,S)+28,4,this.endianness),finalBlockSize:o(this.rawData,l(this,S)+32,4,this.endianness),finalBlockSizeWithPadding:o(this.rawData,l(this,S)+40,4,this.endianness),totalSamplesInFinalBlock:o(this.rawData,l(this,S)+36,4,this.endianness),adpcTableSamplesPerEntry:o(this.rawData,l(this,S)+44,4,this.endianness),adpcTableBytesPerEntry:o(this.rawData,l(this,S)+48,4,this.endianness),numberTracks:s,trackDescriptionType:a,trackDescriptions:r};return u.loopStartSample>=u.totalSamples&&(u.loopFlag=0,u.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),u},Y=new WeakSet,wt=function(e){const{blockSize:s,totalBlocks:a,numberChannels:r,finalBlockSize:u,finalBlockSizeWithPadding:n}=this.metadata,c=[];for(let i=0;i<r;i++)c.push(new Uint8Array(e===a-1?u:s));let h=e;for(let i=0;i<r;i++){const f=i!==0&&h+1===a?h*r*s+i*n:(h*r+i)*s,d=h+1===a?f+u:f+s,m=this.rawData.slice(l(this,j)+32+f,l(this,j)+32+d);c[i].set(m)}return c},q=new WeakSet,gt=function(){if(l(this,L))return l(this,L);const{totalBlocks:e,numberChannels:s}=this.metadata,a=o(this.rawData,l(this,M)+4,4,this.endianness),r=this.rawData.slice(l(this,M)+8,l(this,M)+8+a);let u=0,n=0,c=0;for(let f=0;f<s;f++)n=P(o(r,u,2,this.endianness)),u+=2,c=P(o(r,u,2,this.endianness)),u+=2;const h=[];for(let f=0;f<e;f++){h.push([]);for(let d=0;d<s;d++)f>0&&(n=P(o(r,u,2,this.endianness)),u+=2,c=P(o(r,u,2,this.endianness)),u+=2),h[f].push({yn1:n,yn2:c})}let i=[];for(let f=0;f<s;f++)i.push(h.map(d=>d[f]));return b(this,L,i),i},W=new WeakSet,it=function(e){if(l(this,H)[e])return l(this,H)[e];const{numberChannels:s,totalBlocks:a,totalSamplesInFinalBlock:r,samplesPerBlock:u,codec:n}=this.metadata,c=O(this,V,pt).call(this),h=O(this,Y,wt).call(this,e),i=O(this,q,gt).call(this),f=[],d=e===a-1?r:u;for(let m=0;m<s;m++)f.push(new Int16Array(d));for(let m=0;m<s;m++){const{adpcmCoefficients:w}=c[m],I=h[m],p=[];if(n===2){const k=I[0],{yn1:et,yn2:Nt}=i[m][e];let st=k,X=et,ft=Nt,nt=0;for(let at=0;at<d;){let N=0;at%14===0&&(st=I[nt++]),(at++&1)===0?N=I[nt]>>4:N=I[nt++]&15,N>=8&&(N-=16);const Ot=1<<(st&15),dt=st>>4<<1;N=1024+(Ot*N<<11)+w[tt(dt,0,15)]*X+w[tt(dt+1,0,15)]*ft>>11,ft=X,X=tt(N,-32768,32767),p.push(X)}e<a-1&&(i[m][e+1].yn1=p[d-1],i[m][e+1].yn2=p[d-2])}else if(n===1)for(let k=0;k<d;k++){const et=P(o(I,k*2,2,this.endianness));p.push(et)}else if(n===0)for(let k=0;k<d;k++)p.push(P(I[k])*256);else throw new Error("Invalid codec");f[m].set(p)}return l(this,H)[e]=f,f};let A=null;function Bt(t){A=new Ct(t)}function Pt(){A=null}function Mt(){if(!!A)return A.metadata}function xt(){if(!A)return;const t=A.getAllSamples();return Q(t,t.map(e=>e.buffer))}function Lt(t,e){if(!A)return;const s=A.getSamples(t,e).map(Rt);return Q(s,s.map(a=>a.buffer))}function Rt(t){const e=new Float32Array(t.length);for(let s=0;s<t.length;s++){const a=t[s];e[s]=a<0?a/32768:a/32767}return e}var Ht=Object.freeze({__proto__:null,init:Bt,destroy:Pt,getMetadata:Mt,getAllSamples:xt,getSamples:Lt});J(Ht)})();

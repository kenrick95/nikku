(function(){"use strict";const Z=Symbol("Comlink.proxy"),it=Symbol("Comlink.endpoint"),ot=Symbol("Comlink.releaseProxy"),z=Symbol("Comlink.thrown"),$=t=>typeof t=="object"&&t!==null||typeof t=="function",lt={canHandle:t=>$(t)&&t[Z],serialize(t){const{port1:e,port2:a}=new MessageChannel;return I(t,e),[a,[a]]},deserialize(t){return t.start(),ut(t)}},ht={canHandle:t=>$(t)&&z in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},tt=new Map([["proxy",lt],["throw",ht]]);function I(t,e=self){e.addEventListener("message",function a(s){if(!s||!s.data)return;const{id:l,type:u,path:r}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(T);let i;try{const o=r.slice(0,-1).reduce((f,g)=>f[g],t),m=r.reduce((f,g)=>f[g],t);switch(u){case"GET":i=m;break;case"SET":o[r.slice(-1)[0]]=T(s.data.value),i=!0;break;case"APPLY":i=m.apply(o,c);break;case"CONSTRUCT":{const f=new m(...c);i=dt(f)}break;case"ENDPOINT":{const{port1:f,port2:g}=new MessageChannel;I(t,g),i=F(f,[f])}break;case"RELEASE":i=void 0;break;default:return}}catch(o){i={value:o,[z]:0}}Promise.resolve(i).catch(o=>({value:o,[z]:0})).then(o=>{const[m,f]=W(o);e.postMessage(Object.assign(Object.assign({},m),{id:l}),f),u==="RELEASE"&&(e.removeEventListener("message",a),et(e))})}),e.start&&e.start()}function ct(t){return t.constructor.name==="MessagePort"}function et(t){ct(t)&&t.close()}function ut(t,e){return N(t,[],e)}function _(t){if(t)throw new Error("Proxy has been released and is not useable")}function N(t,e=[],a=function(){}){let s=!1;const l=new Proxy(a,{get(u,r){if(_(s),r===ot)return()=>B(t,{type:"RELEASE",path:e.map(c=>c.toString())}).then(()=>{et(t),s=!0});if(r==="then"){if(e.length===0)return{then:()=>l};const c=B(t,{type:"GET",path:e.map(i=>i.toString())}).then(T);return c.then.bind(c)}return N(t,[...e,r])},set(u,r,c){_(s);const[i,o]=W(c);return B(t,{type:"SET",path:[...e,r].map(m=>m.toString()),value:i},o).then(T)},apply(u,r,c){_(s);const i=e[e.length-1];if(i===it)return B(t,{type:"ENDPOINT"}).then(T);if(i==="bind")return N(t,e.slice(0,-1));const[o,m]=st(c);return B(t,{type:"APPLY",path:e.map(f=>f.toString()),argumentList:o},m).then(T)},construct(u,r){_(s);const[c,i]=st(r);return B(t,{type:"CONSTRUCT",path:e.map(o=>o.toString()),argumentList:c},i).then(T)}});return l}function ft(t){return Array.prototype.concat.apply([],t)}function st(t){const e=t.map(W);return[e.map(a=>a[0]),ft(e.map(a=>a[1]))]}const nt=new WeakMap;function F(t,e){return nt.set(t,e),t}function dt(t){return Object.assign(t,{[Z]:!0})}function W(t){for(const[e,a]of tt)if(a.canHandle(t)){const[s,l]=a.serialize(t);return[{type:"HANDLER",name:e,value:s},l]}return[{type:"RAW",value:t},nt.get(t)||[]]}function T(t){switch(t.type){case"HANDLER":return tt.get(t.name).deserialize(t.value);case"RAW":return t.value}}function B(t,e,a){return new Promise(s=>{const l=pt();t.addEventListener("message",function u(r){!r.data||!r.data.id||r.data.id!==l||(t.removeEventListener("message",u),s(r.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:l},e),a)})}function pt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}var mt=0;function b(t){return"__private_"+mt+++"_"+t}function n(t,e){if(!Object.prototype.hasOwnProperty.call(t,e))throw new TypeError("attempted to use private field on non-instance");return t}function U(t,e,a){const s=[];for(let l=e;l<e+a;l++)s.push(t[l]);return s}function h(t,e,a,s=1){const l=U(t,e,a);return s===0&&l.reverse(),l.reduce((u,r)=>256*u+r,0)}function V(t,e,a){return t<=e?e:t>=a?a:t}function M(t){return t>=32768?t-65536:t}var y=b("offsetToHead"),d=b("offsetToHeadChunk1"),D=b("offsetToHeadChunk2"),x=b("offsetToHeadChunk3"),P=b("offsetToAdpc"),j=b("offsetToData"),k=b("cachedSamples"),E=b("partitionedAdpcChunkData"),v=b("cachedChannelInfo"),C=b("cachedBlockResults"),G=b("getChannelInfo"),Y=b("getMetadata"),q=b("getPartitionedBlockData"),X=b("getPartitionedAdpcChunkData"),L=b("getSamplesAtBlock");class wt{constructor(e){if(Object.defineProperty(this,L,{value:Dt}),Object.defineProperty(this,X,{value:St}),Object.defineProperty(this,q,{value:bt}),Object.defineProperty(this,Y,{value:gt}),Object.defineProperty(this,G,{value:yt}),Object.defineProperty(this,y,{writable:!0,value:void 0}),Object.defineProperty(this,d,{writable:!0,value:void 0}),Object.defineProperty(this,D,{writable:!0,value:void 0}),Object.defineProperty(this,x,{writable:!0,value:void 0}),Object.defineProperty(this,P,{writable:!0,value:void 0}),Object.defineProperty(this,j,{writable:!0,value:void 0}),Object.defineProperty(this,k,{writable:!0,value:void 0}),Object.defineProperty(this,E,{writable:!0,value:void 0}),Object.defineProperty(this,v,{writable:!0,value:void 0}),Object.defineProperty(this,C,{writable:!0,value:void 0}),n(this,k)[k]=null,n(this,E)[E]=null,n(this,v)[v]=null,n(this,C)[C]=[],this.rawData=new Uint8Array(e),function(a,s,l,u=1){const r=U(a,0,4);return u===0&&r.reverse(),String.fromCharCode(...r)}(this.rawData)!=="RSTM")throw new Error("Not a valid BRSTM file");this.endianness=function(a){const s=U(a,4,2);return s[0]===255&&s[1]===254?0:1}(this.rawData),n(this,y)[y]=h(this.rawData,16,4,this.endianness),n(this,d)[d]=n(this,y)[y]+h(this.rawData,n(this,y)[y]+12,4,this.endianness)+8,n(this,D)[D]=n(this,y)[y]+h(this.rawData,n(this,y)[y]+20,4,this.endianness)+8,n(this,x)[x]=n(this,y)[y]+h(this.rawData,n(this,y)[y]+28,4,this.endianness)+8,n(this,P)[P]=h(this.rawData,24,4,this.endianness),n(this,j)[j]=h(this.rawData,32,4,this.endianness),this.metadata=n(this,Y)[Y]()}getAllSamples(){if(n(this,k)[k])return n(this,k)[k];const{numberChannels:e,totalSamples:a,totalBlocks:s,samplesPerBlock:l}=this.metadata,u=[];for(let r=0;r<e;r++)u.push(new Int16Array(a));for(let r=0;r<s;r++){const c=n(this,L)[L](r);for(let i=0;i<e;i++)u[i].set(c[i],r*l)}return n(this,k)[k]=u,u}getBuffer(e,a){return this.getSamples(e,a)}getSamples(e,a){const{numberChannels:s,totalBlocks:l,totalSamples:u,samplesPerBlock:r}=this.metadata,c=Math.max(0,e),i=Math.min(u,e+a),o=Math.max(0,Math.floor(c/r)),m=Math.min(l-1,Math.floor(i/r)),f=[];for(let w=o;w<=m;w++)f.push(n(this,L)[L](w));const g=[];for(let w=0;w<s;w++)g.push(new Int16Array(i-c));for(let w=o;w<=m;w++){const S=w-o;if(w===o&&w===m)for(let p=0;p<s;p++)g[p].set(f[S][p].slice(c-o*r,c-o*r+a),0);else if(w===o)for(let p=0;p<s;p++){const O=f[S][p].slice(c-o*r);g[p].set(O,0)}else if(w===m)for(let p=0;p<s;p++){const O=f[S][p].slice(0,i-f[S][p].length-o*r);g[p].set(O.length+(w*r-c)>g[p].length?O.slice(0,a-(w*r-c)):O,w*r-c)}else for(let p=0;p<s;p++)g[p].set(f[S][p],w*r-c)}return g}}function yt(){if(n(this,v)[v])return n(this,v)[v];const{numberChannels:t}=this.metadata,e=[];for(let a=0;a<t;a++){const s=n(this,y)[y]+h(this.rawData,n(this,x)[x]+8+8*a,4,this.endianness)+8+8,l=[];for(let u=0;u<16;u++){const r=h(this.rawData,s+2*u,2,this.endianness);l.push(M(r))}e.push({adpcmCoefficients:l,gain:h(this.rawData,s+40,2,this.endianness),initialPredictorScale:h(this.rawData,s+42,2,this.endianness),historySample1:h(this.rawData,s+44,2,this.endianness),historySample2:h(this.rawData,s+46,2,this.endianness),loopPredictorScale:h(this.rawData,s+48,2,this.endianness),loopHistorySample1:h(this.rawData,s+50,2,this.endianness),loopHistorySample2:h(this.rawData,s+52,2,this.endianness)})}return n(this,v)[v]=e,e}function gt(){const t=h(this.rawData,n(this,d)[d]+2,1,this.endianness),e=h(this.rawData,n(this,D)[D],1,this.endianness),a=h(this.rawData,n(this,D)[D]+1,1,this.endianness),s=[];for(let u=0;u<e;u++){const r=n(this,y)[y]+8+h(this.rawData,n(this,D)[D]+4+8*u+4,4,this.endianness),c=h(this.rawData,n(this,D)[D]+4+8*u+1,1,this.endianness);let i=0;c===0?i=h(this.rawData,r,1,this.endianness):c===1&&(i=h(this.rawData,r+8,1,this.endianness)),s.push({numberChannels:i,type:c})}const l={fileSize:h(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:h(this.rawData,n(this,d)[d],1,this.endianness),loopFlag:h(this.rawData,n(this,d)[d]+1,1,this.endianness),numberChannels:t,sampleRate:h(this.rawData,n(this,d)[d]+4,2,this.endianness),loopStartSample:h(this.rawData,n(this,d)[d]+8,4,this.endianness),totalSamples:h(this.rawData,n(this,d)[d]+12,4,this.endianness),totalBlocks:h(this.rawData,n(this,d)[d]+20,4,this.endianness),blockSize:h(this.rawData,n(this,d)[d]+24,4,this.endianness),samplesPerBlock:h(this.rawData,n(this,d)[d]+28,4,this.endianness),finalBlockSize:h(this.rawData,n(this,d)[d]+32,4,this.endianness),finalBlockSizeWithPadding:h(this.rawData,n(this,d)[d]+40,4,this.endianness),totalSamplesInFinalBlock:h(this.rawData,n(this,d)[d]+36,4,this.endianness),adpcTableSamplesPerEntry:h(this.rawData,n(this,d)[d]+44,4,this.endianness),adpcTableBytesPerEntry:h(this.rawData,n(this,d)[d]+48,4,this.endianness),numberTracks:e,trackDescriptionType:a,trackDescriptions:s};return l.loopStartSample>=l.totalSamples&&(l.loopFlag=0,l.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),l}function bt(t){const{blockSize:e,totalBlocks:a,numberChannels:s,finalBlockSize:l,finalBlockSizeWithPadding:u}=this.metadata,r=[];for(let i=0;i<s;i++)r.push(new Uint8Array(t===a-1?l:e));let c=t;for(let i=0;i<s;i++){const o=i!==0&&c+1===a?c*s*e+i*u:(c*s+i)*e,m=c+1===a?o+l:o+e,f=this.rawData.slice(n(this,j)[j]+32+o,n(this,j)[j]+32+m);r[i].set(f)}return r}function St(){if(n(this,E)[E])return n(this,E)[E];const{totalBlocks:t,numberChannels:e}=this.metadata,a=h(this.rawData,n(this,P)[P]+4,4,this.endianness),s=this.rawData.slice(n(this,P)[P]+8,n(this,P)[P]+8+a);let l=0,u=0,r=0;for(let o=0;o<e;o++)u=M(h(s,l,2,this.endianness)),l+=2,r=M(h(s,l,2,this.endianness)),l+=2;const c=[];for(let o=0;o<t;o++){c.push([]);for(let m=0;m<e;m++)o>0&&(u=M(h(s,l,2,this.endianness)),l+=2,r=M(h(s,l,2,this.endianness)),l+=2),c[o].push({yn1:u,yn2:r})}let i=[];for(let o=0;o<e;o++)i.push(c.map(m=>m[o]));return n(this,E)[E]=i,i}function Dt(t){if(n(this,C)[C][t])return n(this,C)[C][t];const{numberChannels:e,totalBlocks:a,totalSamplesInFinalBlock:s,samplesPerBlock:l,codec:u}=this.metadata,r=n(this,G)[G](),c=n(this,q)[q](t),i=n(this,X)[X](),o=[],m=t===a-1?s:l;for(let f=0;f<e;f++)o.push(new Int16Array(m));for(let f=0;f<e;f++){const{adpcmCoefficients:g}=r[f],w=c[f],S=[];if(u===2){const p=w[0],{yn1:O,yn2:Tt}=i[f][t];let J=p,H=O,at=Tt,K=0;for(let Q=0;Q<m;){let R=0;Q%14==0&&(J=w[K++]),R=(1&Q++)==0?w[K]>>4:15&w[K++],R>=8&&(R-=16);const rt=J>>4<<1;R=1024+((1<<(15&J))*R<<11)+g[V(rt,0,15)]*H+g[V(rt+1,0,15)]*at>>11,at=H,H=V(R,-32768,32767),S.push(H)}t<a-1&&(i[f][t+1].yn1=S[m-1],i[f][t+1].yn2=S[m-2])}else if(u===1)for(let p=0;p<m;p++){const O=M(h(w,2*p,2,this.endianness));S.push(O)}else{if(u!==0)throw new Error("Invalid codec");for(let p=0;p<m;p++)S.push(256*M(w[p]))}o[f].set(S)}return n(this,C)[C][t]=o,o}let A=null;function Pt(t){A=new wt(t)}function kt(){A=null}function Et(){if(!!A)return A.metadata}function vt(){if(!A)return;const t=A.getAllSamples();return F(t,t.map(e=>e.buffer))}function Ct(t,e){if(!A)return;const a=A.getSamples(t,e).map(Ot);return F(a,a.map(s=>s.buffer))}function Ot(t){const e=new Float32Array(t.length);for(let a=0;a<t.length;a++){const s=t[a];e[a]=s<0?s/32768:s/32767}return e}var At=Object.freeze({__proto__:null,init:Pt,destroy:kt,getMetadata:Et,getAllSamples:vt,getSamples:Ct});I(At)})();

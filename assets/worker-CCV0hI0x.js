var pt=g=>{throw TypeError(g)};var at=(g,S,k)=>S.has(g)||pt("Cannot "+k);var c=(g,S,k)=>(at(g,S,"read from private field"),k?k.call(g):S.get(g)),C=(g,S,k)=>S.has(g)?pt("Cannot add the same private member more than once"):S instanceof WeakSet?S.add(g):S.set(g,k),I=(g,S,k,O)=>(at(g,S,"write to private field"),O?O.call(g,k):S.set(g,k),k),z=(g,S,k)=>(at(g,S,"access private method"),k);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var E,y,P,U,x,N,F,_,W,G,b,mt,wt,gt,yt,rt;const g=Symbol("Comlink.proxy"),S=Symbol("Comlink.endpoint"),k=Symbol("Comlink.releaseProxy"),O=Symbol("Comlink.finalizer"),V=Symbol("Comlink.thrown"),it=t=>typeof t=="object"&&t!==null||typeof t=="function",St={canHandle:t=>it(t)&&t[g],serialize(t){const{port1:e,port2:s}=new MessageChannel;return $(t,e),[s,[s]]},deserialize(t){return t.start(),Et(t)}},Dt={canHandle:t=>it(t)&&V in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},ot=new Map([["proxy",St],["throw",Dt]]);function kt(t,e){for(const s of t)if(e===s||s==="*"||s instanceof RegExp&&s.test(e))return!0;return!1}function $(t,e=globalThis,s=["*"]){e.addEventListener("message",function o(n){if(!n||!n.data)return;if(!kt(s,n.origin)){console.warn(`Invalid origin '${n.origin}' for comlink proxy`);return}const{id:i,type:a,path:f}=Object.assign({path:[]},n.data),d=(n.data.argumentList||[]).map(M);let r;try{const h=f.slice(0,-1).reduce((u,w)=>u[w],t),p=f.reduce((u,w)=>u[w],t);switch(a){case"GET":r=p;break;case"SET":h[f.slice(-1)[0]]=M(n.data.value),r=!0;break;case"APPLY":r=p.apply(h,d);break;case"CONSTRUCT":{const u=new p(...d);r=At(u)}break;case"ENDPOINT":{const{port1:u,port2:w}=new MessageChannel;$(t,w),r=K(u,[u])}break;case"RELEASE":r=void 0;break;default:return}}catch(h){r={value:h,[V]:0}}Promise.resolve(r).catch(h=>({value:h,[V]:0})).then(h=>{const[p,u]=q(h);e.postMessage(Object.assign(Object.assign({},p),{id:i}),u),a==="RELEASE"&&(e.removeEventListener("message",o),lt(e),O in t&&typeof t[O]=="function"&&t[O]())}).catch(h=>{const[p,u]=q({value:new TypeError("Unserializable return value"),[V]:0});e.postMessage(Object.assign(Object.assign({},p),{id:i}),u)})}),e.start&&e.start()}function bt(t){return t.constructor.name==="MessagePort"}function lt(t){bt(t)&&t.close()}function Et(t,e){const s=new Map;return t.addEventListener("message",function(n){const{data:i}=n;if(!i||!i.id)return;const a=s.get(i.id);if(a)try{a(i)}finally{s.delete(i.id)}}),J(t,s,[],e)}function j(t){if(t)throw new Error("Proxy has been released and is not useable")}function ct(t){return L(t,new Map,{type:"RELEASE"}).then(()=>{lt(t)})}const v=new WeakMap,Y="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(v.get(t)||0)-1;v.set(t,e),e===0&&ct(t)});function Tt(t,e){const s=(v.get(e)||0)+1;v.set(e,s),Y&&Y.register(t,e,t)}function Ct(t){Y&&Y.unregister(t)}function J(t,e,s=[],o=function(){}){let n=!1;const i=new Proxy(o,{get(a,f){if(j(n),f===k)return()=>{Ct(i),ct(t),e.clear(),n=!0};if(f==="then"){if(s.length===0)return{then:()=>i};const d=L(t,e,{type:"GET",path:s.map(r=>r.toString())}).then(M);return d.then.bind(d)}return J(t,e,[...s,f])},set(a,f,d){j(n);const[r,h]=q(d);return L(t,e,{type:"SET",path:[...s,f].map(p=>p.toString()),value:r},h).then(M)},apply(a,f,d){j(n);const r=s[s.length-1];if(r===S)return L(t,e,{type:"ENDPOINT"}).then(M);if(r==="bind")return J(t,e,s.slice(0,-1));const[h,p]=ht(d);return L(t,e,{type:"APPLY",path:s.map(u=>u.toString()),argumentList:h},p).then(M)},construct(a,f){j(n);const[d,r]=ht(f);return L(t,e,{type:"CONSTRUCT",path:s.map(h=>h.toString()),argumentList:d},r).then(M)}});return Tt(i,t),i}function It(t){return Array.prototype.concat.apply([],t)}function ht(t){const e=t.map(q);return[e.map(s=>s[0]),It(e.map(s=>s[1]))]}const ft=new WeakMap;function K(t,e){return ft.set(t,e),t}function At(t){return Object.assign(t,{[g]:!0})}function q(t){for(const[e,s]of ot)if(s.canHandle(t)){const[o,n]=s.serialize(t);return[{type:"HANDLER",name:e,value:o},n]}return[{type:"RAW",value:t},ft.get(t)||[]]}function M(t){switch(t.type){case"HANDLER":return ot.get(t.name).deserialize(t.value);case"RAW":return t.value}}function L(t,e,s,o){return new Promise(n=>{const i=Pt();e.set(i,n),t.start&&t.start(),t.postMessage(Object.assign({id:i},s),o)})}function Pt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function Q(t,e,s){const o=[];for(let n=e;n<e+s;n++)o.push(t[n]);return o}const H={LITTLE:0,BIG:1};function Mt(t){const e=Q(t,4,2);return e[0]===255&&e[1]===254?H.LITTLE:H.BIG}function Bt(t,e,s,o=H.BIG){const n=Q(t,e,s);return o===H.LITTLE&&n.reverse(),String.fromCharCode(...n)}function l(t,e,s,o=H.BIG){const n=Q(t,e,s);return o===H.LITTLE&&n.reverse(),n.reduce((i,a)=>i*256+a,0)}function Z(t,e,s){return t<=e?e:t>=s?s:t}function B(t){return t>=32768?t-65536:t}class xt{constructor(e){C(this,b);C(this,E);C(this,y);C(this,P);C(this,U);C(this,x);C(this,N);C(this,F,null);C(this,_,null);C(this,W,null);C(this,G,[]);if(this.rawData=new Uint8Array(e),Bt(this.rawData,0,4)!=="RSTM")throw new Error("Not a valid BRSTM file");this.endianness=Mt(this.rawData),I(this,E,l(this.rawData,16,4,this.endianness)),I(this,y,c(this,E)+l(this.rawData,c(this,E)+12,4,this.endianness)+8),I(this,P,c(this,E)+l(this.rawData,c(this,E)+20,4,this.endianness)+8),I(this,U,c(this,E)+l(this.rawData,c(this,E)+28,4,this.endianness)+8),I(this,x,l(this.rawData,24,4,this.endianness)),I(this,N,l(this.rawData,32,4,this.endianness)),this.metadata=z(this,b,wt).call(this)}getAllSamples(){if(c(this,F))return c(this,F);const{numberChannels:e,totalSamples:s,totalBlocks:o,samplesPerBlock:n}=this.metadata,i=[];for(let a=0;a<e;a++)i.push(new Int16Array(s));for(let a=0;a<o;a++){const f=z(this,b,rt).call(this,a);for(let d=0;d<e;d++)i[d].set(f[d],a*n)}return I(this,F,i),i}getBuffer(e,s){return this.getSamples(e,s)}getSamples(e,s){const{numberChannels:o,totalBlocks:n,totalSamples:i,samplesPerBlock:a}=this.metadata,f=Math.max(0,e),d=Math.min(i,e+s),r=Math.max(0,Math.floor(f/a)),h=Math.min(n-1,Math.floor(d/a)),p=[];for(let w=r;w<=h;w++)p.push(z(this,b,rt).call(this,w));const u=[];for(let w=0;w<o;w++)u.push(new Int16Array(d-f));for(let w=r;w<=h;w++){const T=w-r;if(w===r&&w===h)for(let m=0;m<o;m++)u[m].set(p[T][m].slice(f-r*a,f-r*a+s),0);else if(w===r)for(let m=0;m<o;m++){const D=p[T][m].slice(f-r*a);u[m].set(D,0)}else if(w===h)for(let m=0;m<o;m++){const D=p[T][m].slice(0,d-p[T][m].length-r*a);D.length+(w*a-f)>u[m].length?u[m].set(D.slice(0,s-(w*a-f)),w*a-f):u[m].set(D,w*a-f)}else for(let m=0;m<o;m++)u[m].set(p[T][m],w*a-f)}return u}}E=new WeakMap,y=new WeakMap,P=new WeakMap,U=new WeakMap,x=new WeakMap,N=new WeakMap,F=new WeakMap,_=new WeakMap,W=new WeakMap,G=new WeakMap,b=new WeakSet,mt=function(){if(c(this,W))return c(this,W);const{numberChannels:e}=this.metadata,s=[];for(let o=0;o<e;o++){const n=c(this,E)+l(this.rawData,c(this,U)+8+o*8,4,this.endianness)+8+8,i=[];for(let a=0;a<16;a++){const f=l(this.rawData,n+2*a,2,this.endianness);i.push(B(f))}s.push({adpcmCoefficients:i,gain:l(this.rawData,n+40,2,this.endianness),initialPredictorScale:l(this.rawData,n+42,2,this.endianness),historySample1:l(this.rawData,n+44,2,this.endianness),historySample2:l(this.rawData,n+46,2,this.endianness),loopPredictorScale:l(this.rawData,n+48,2,this.endianness),loopHistorySample1:l(this.rawData,n+50,2,this.endianness),loopHistorySample2:l(this.rawData,n+52,2,this.endianness)})}return I(this,W,s),s},wt=function(){const e=l(this.rawData,c(this,y)+2,1,this.endianness),s=l(this.rawData,c(this,P),1,this.endianness),o=l(this.rawData,c(this,P)+1,1,this.endianness),n=[];for(let a=0;a<s;a++){const f=c(this,E)+8+l(this.rawData,c(this,P)+4+a*8+4,4,this.endianness),d=l(this.rawData,c(this,P)+4+a*8+1,1,this.endianness);let r=0;d===0?r=l(this.rawData,f,1,this.endianness):d===1&&(r=l(this.rawData,f+8,1,this.endianness)),n.push({numberChannels:r,type:d})}const i={fileSize:l(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:l(this.rawData,c(this,y),1,this.endianness),loopFlag:l(this.rawData,c(this,y)+1,1,this.endianness),numberChannels:e,sampleRate:l(this.rawData,c(this,y)+4,2,this.endianness),loopStartSample:l(this.rawData,c(this,y)+8,4,this.endianness),totalSamples:l(this.rawData,c(this,y)+12,4,this.endianness),totalBlocks:l(this.rawData,c(this,y)+20,4,this.endianness),blockSize:l(this.rawData,c(this,y)+24,4,this.endianness),samplesPerBlock:l(this.rawData,c(this,y)+28,4,this.endianness),finalBlockSize:l(this.rawData,c(this,y)+32,4,this.endianness),finalBlockSizeWithPadding:l(this.rawData,c(this,y)+40,4,this.endianness),totalSamplesInFinalBlock:l(this.rawData,c(this,y)+36,4,this.endianness),adpcTableSamplesPerEntry:l(this.rawData,c(this,y)+44,4,this.endianness),adpcTableBytesPerEntry:l(this.rawData,c(this,y)+48,4,this.endianness),numberTracks:s,trackDescriptionType:o,trackDescriptions:n};return i.loopStartSample>=i.totalSamples&&(i.loopFlag=0,i.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),i},gt=function(e){const{blockSize:s,totalBlocks:o,numberChannels:n,finalBlockSize:i,finalBlockSizeWithPadding:a}=this.metadata,f=[];for(let r=0;r<n;r++)f.push(new Uint8Array(e===o-1?i:s));let d=e;for(let r=0;r<n;r++){const h=r!==0&&d+1===o?d*n*s+r*a:(d*n+r)*s,p=d+1===o?h+i:h+s,u=this.rawData.slice(c(this,N)+32+h,c(this,N)+32+p);f[r].set(u)}return f},yt=function(){if(c(this,_))return c(this,_);const{totalBlocks:e,numberChannels:s}=this.metadata,o=l(this.rawData,c(this,x)+4,4,this.endianness),n=this.rawData.slice(c(this,x)+8,c(this,x)+8+o);let i=0,a=0,f=0;for(let h=0;h<s;h++)a=B(l(n,i,2,this.endianness)),i+=2,f=B(l(n,i,2,this.endianness)),i+=2;const d=[];for(let h=0;h<e;h++){d.push([]);for(let p=0;p<s;p++)h>0&&(a=B(l(n,i,2,this.endianness)),i+=2,f=B(l(n,i,2,this.endianness)),i+=2),d[h].push({yn1:a,yn2:f})}let r=[];for(let h=0;h<s;h++)r.push(d.map(p=>p[h]));return I(this,_,r),r},rt=function(e){if(c(this,G)[e])return c(this,G)[e];const{numberChannels:s,totalBlocks:o,totalSamplesInFinalBlock:n,samplesPerBlock:i,codec:a}=this.metadata,f=z(this,b,mt).call(this),d=z(this,b,gt).call(this,e),r=z(this,b,yt).call(this),h=[],p=e===o-1?n:i;for(let u=0;u<s;u++)h.push(new Int16Array(p));for(let u=0;u<s;u++){const{adpcmCoefficients:w}=f[u],T=d[u],m=[];if(a===2){const D=T[0],{yn1:tt,yn2:_t}=r[u][e];let et=D,X=tt,ut=_t,st=0;for(let nt=0;nt<p;){let R=0;nt%14===0&&(et=T[st++]),(nt++&1)===0?R=T[st]>>4:R=T[st++]&15,R>=8&&(R-=16);const Wt=1<<(et&15),dt=et>>4<<1;R=1024+(Wt*R<<11)+w[Z(dt,0,15)]*X+w[Z(dt+1,0,15)]*ut>>11,ut=X,X=Z(R,-32768,32767),m.push(X)}e<o-1&&(r[u][e+1].yn1=m[p-1],r[u][e+1].yn2=m[p-2])}else if(a===1)for(let D=0;D<p;D++){const tt=B(l(T,D*2,2,this.endianness));m.push(tt)}else if(a===0)for(let D=0;D<p;D++)m.push(B(T[D])*256);else throw new Error("Invalid codec");h[u].set(m)}return c(this,G)[e]=h,h};let A=null;function Rt(t){A=new xt(t)}function zt(){A=null}function Ot(){if(A)return A.metadata}function Lt(){if(!A)return;const t=A.getAllSamples();return K(t,t.map(e=>e.buffer))}function Ht(t,e){if(!A)return;const s=A.getSamples(t,e).map(Nt);return K(s,s.map(o=>o.buffer))}function Nt(t){const e=new Float32Array(t.length);for(let s=0;s<t.length;s++){const o=t[s];e[s]=o<0?o/32768:o/32767}return e}var Ft=Object.freeze({__proto__:null,destroy:zt,getAllSamples:Lt,getMetadata:Ot,getSamples:Ht,init:Rt});$(Ft)})();

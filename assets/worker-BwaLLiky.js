var pt=w=>{throw TypeError(w)};var at=(w,S,k)=>S.has(w)||pt("Cannot "+k);var l=(w,S,k)=>(at(w,S,"read from private field"),k?k.call(w):S.get(w)),C=(w,S,k)=>S.has(w)?pt("Cannot add the same private member more than once"):S instanceof WeakSet?S.add(w):S.set(w,k),I=(w,S,k,z)=>(at(w,S,"write to private field"),z?z.call(w,k):S.set(w,k),k),L=(w,S,k)=>(at(w,S,"access private method"),k);(function(){"use strict";/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */var E,y,P,U,M,N,F,_,W,G,b,mt,gt,wt,yt,rt;const w=Symbol("Comlink.proxy"),S=Symbol("Comlink.endpoint"),k=Symbol("Comlink.releaseProxy"),z=Symbol("Comlink.finalizer"),V=Symbol("Comlink.thrown"),it=t=>typeof t=="object"&&t!==null||typeof t=="function",St={canHandle:t=>it(t)&&t[w],serialize(t){const{port1:e,port2:s}=new MessageChannel;return $(t,e),[s,[s]]},deserialize(t){return t.start(),Et(t)}},Dt={canHandle:t=>it(t)&&V in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},ot=new Map([["proxy",St],["throw",Dt]]);function kt(t,e){for(const s of t)if(e===s||s==="*"||s instanceof RegExp&&s.test(e))return!0;return!1}function $(t,e=globalThis,s=["*"]){e.addEventListener("message",function r(a){if(!a||!a.data)return;if(!kt(s,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:c,type:n,path:h}=Object.assign({path:[]},a.data),f=(a.data.argumentList||[]).map(B);let i;try{const u=h.slice(0,-1).reduce((d,g)=>d[g],t),p=h.reduce((d,g)=>d[g],t);switch(n){case"GET":i=p;break;case"SET":u[h.slice(-1)[0]]=B(a.data.value),i=!0;break;case"APPLY":i=p.apply(u,f);break;case"CONSTRUCT":{const d=new p(...f);i=At(d)}break;case"ENDPOINT":{const{port1:d,port2:g}=new MessageChannel;$(t,g),i=K(d,[d])}break;case"RELEASE":i=void 0;break;default:return}}catch(u){i={value:u,[V]:0}}Promise.resolve(i).catch(u=>({value:u,[V]:0})).then(u=>{const[p,d]=q(u);e.postMessage(Object.assign(Object.assign({},p),{id:c}),d),n==="RELEASE"&&(e.removeEventListener("message",r),lt(e),z in t&&typeof t[z]=="function"&&t[z]())}).catch(u=>{const[p,d]=q({value:new TypeError("Unserializable return value"),[V]:0});e.postMessage(Object.assign(Object.assign({},p),{id:c}),d)})}),e.start&&e.start()}function bt(t){return t.constructor.name==="MessagePort"}function lt(t){bt(t)&&t.close()}function Et(t,e){return J(t,[],e)}function j(t){if(t)throw new Error("Proxy has been released and is not useable")}function ct(t){return O(t,{type:"RELEASE"}).then(()=>{lt(t)})}const v=new WeakMap,Y="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(v.get(t)||0)-1;v.set(t,e),e===0&&ct(t)});function Tt(t,e){const s=(v.get(e)||0)+1;v.set(e,s),Y&&Y.register(t,e,t)}function Ct(t){Y&&Y.unregister(t)}function J(t,e=[],s=function(){}){let r=!1;const a=new Proxy(s,{get(c,n){if(j(r),n===k)return()=>{Ct(a),ct(t),r=!0};if(n==="then"){if(e.length===0)return{then:()=>a};const h=O(t,{type:"GET",path:e.map(f=>f.toString())}).then(B);return h.then.bind(h)}return J(t,[...e,n])},set(c,n,h){j(r);const[f,i]=q(h);return O(t,{type:"SET",path:[...e,n].map(u=>u.toString()),value:f},i).then(B)},apply(c,n,h){j(r);const f=e[e.length-1];if(f===S)return O(t,{type:"ENDPOINT"}).then(B);if(f==="bind")return J(t,e.slice(0,-1));const[i,u]=ht(h);return O(t,{type:"APPLY",path:e.map(p=>p.toString()),argumentList:i},u).then(B)},construct(c,n){j(r);const[h,f]=ht(n);return O(t,{type:"CONSTRUCT",path:e.map(i=>i.toString()),argumentList:h},f).then(B)}});return Tt(a,t),a}function It(t){return Array.prototype.concat.apply([],t)}function ht(t){const e=t.map(q);return[e.map(s=>s[0]),It(e.map(s=>s[1]))]}const ut=new WeakMap;function K(t,e){return ut.set(t,e),t}function At(t){return Object.assign(t,{[w]:!0})}function q(t){for(const[e,s]of ot)if(s.canHandle(t)){const[r,a]=s.serialize(t);return[{type:"HANDLER",name:e,value:r},a]}return[{type:"RAW",value:t},ut.get(t)||[]]}function B(t){switch(t.type){case"HANDLER":return ot.get(t.name).deserialize(t.value);case"RAW":return t.value}}function O(t,e,s){return new Promise(r=>{const a=Pt();t.addEventListener("message",function c(n){!n.data||!n.data.id||n.data.id!==a||(t.removeEventListener("message",c),r(n.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:a},e),s)})}function Pt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function Q(t,e,s){const r=[];for(let a=e;a<e+s;a++)r.push(t[a]);return r}const H={LITTLE:0,BIG:1};function Bt(t){const e=Q(t,4,2);return e[0]===255&&e[1]===254?H.LITTLE:H.BIG}function xt(t,e,s,r=H.BIG){const a=Q(t,e,s);return r===H.LITTLE&&a.reverse(),String.fromCharCode(...a)}function o(t,e,s,r=H.BIG){const a=Q(t,e,s);return r===H.LITTLE&&a.reverse(),a.reduce((c,n)=>c*256+n,0)}function Z(t,e,s){return t<=e?e:t>=s?s:t}function x(t){return t>=32768?t-65536:t}class Mt{constructor(e){C(this,b);C(this,E);C(this,y);C(this,P);C(this,U);C(this,M);C(this,N);C(this,F,null);C(this,_,null);C(this,W,null);C(this,G,[]);if(this.rawData=new Uint8Array(e),xt(this.rawData,0,4)!=="RSTM")throw new Error("Not a valid BRSTM file");this.endianness=Bt(this.rawData),I(this,E,o(this.rawData,16,4,this.endianness)),I(this,y,l(this,E)+o(this.rawData,l(this,E)+12,4,this.endianness)+8),I(this,P,l(this,E)+o(this.rawData,l(this,E)+20,4,this.endianness)+8),I(this,U,l(this,E)+o(this.rawData,l(this,E)+28,4,this.endianness)+8),I(this,M,o(this.rawData,24,4,this.endianness)),I(this,N,o(this.rawData,32,4,this.endianness)),this.metadata=L(this,b,gt).call(this)}getAllSamples(){if(l(this,F))return l(this,F);const{numberChannels:e,totalSamples:s,totalBlocks:r,samplesPerBlock:a}=this.metadata,c=[];for(let n=0;n<e;n++)c.push(new Int16Array(s));for(let n=0;n<r;n++){const h=L(this,b,rt).call(this,n);for(let f=0;f<e;f++)c[f].set(h[f],n*a)}return I(this,F,c),c}getBuffer(e,s){return this.getSamples(e,s)}getSamples(e,s){const{numberChannels:r,totalBlocks:a,totalSamples:c,samplesPerBlock:n}=this.metadata,h=Math.max(0,e),f=Math.min(c,e+s),i=Math.max(0,Math.floor(h/n)),u=Math.min(a-1,Math.floor(f/n)),p=[];for(let g=i;g<=u;g++)p.push(L(this,b,rt).call(this,g));const d=[];for(let g=0;g<r;g++)d.push(new Int16Array(f-h));for(let g=i;g<=u;g++){const T=g-i;if(g===i&&g===u)for(let m=0;m<r;m++)d[m].set(p[T][m].slice(h-i*n,h-i*n+s),0);else if(g===i)for(let m=0;m<r;m++){const D=p[T][m].slice(h-i*n);d[m].set(D,0)}else if(g===u)for(let m=0;m<r;m++){const D=p[T][m].slice(0,f-p[T][m].length-i*n);D.length+(g*n-h)>d[m].length?d[m].set(D.slice(0,s-(g*n-h)),g*n-h):d[m].set(D,g*n-h)}else for(let m=0;m<r;m++)d[m].set(p[T][m],g*n-h)}return d}}E=new WeakMap,y=new WeakMap,P=new WeakMap,U=new WeakMap,M=new WeakMap,N=new WeakMap,F=new WeakMap,_=new WeakMap,W=new WeakMap,G=new WeakMap,b=new WeakSet,mt=function(){if(l(this,W))return l(this,W);const{numberChannels:e}=this.metadata,s=[];for(let r=0;r<e;r++){const a=l(this,E)+o(this.rawData,l(this,U)+8+r*8,4,this.endianness)+8+8,c=[];for(let n=0;n<16;n++){const h=o(this.rawData,a+2*n,2,this.endianness);c.push(x(h))}s.push({adpcmCoefficients:c,gain:o(this.rawData,a+40,2,this.endianness),initialPredictorScale:o(this.rawData,a+42,2,this.endianness),historySample1:o(this.rawData,a+44,2,this.endianness),historySample2:o(this.rawData,a+46,2,this.endianness),loopPredictorScale:o(this.rawData,a+48,2,this.endianness),loopHistorySample1:o(this.rawData,a+50,2,this.endianness),loopHistorySample2:o(this.rawData,a+52,2,this.endianness)})}return I(this,W,s),s},gt=function(){const e=o(this.rawData,l(this,y)+2,1,this.endianness),s=o(this.rawData,l(this,P),1,this.endianness),r=o(this.rawData,l(this,P)+1,1,this.endianness),a=[];for(let n=0;n<s;n++){const h=l(this,E)+8+o(this.rawData,l(this,P)+4+n*8+4,4,this.endianness),f=o(this.rawData,l(this,P)+4+n*8+1,1,this.endianness);let i=0;f===0?i=o(this.rawData,h,1,this.endianness):f===1&&(i=o(this.rawData,h+8,1,this.endianness)),a.push({numberChannels:i,type:f})}const c={fileSize:o(this.rawData,8,4,this.endianness),endianness:this.endianness,codec:o(this.rawData,l(this,y),1,this.endianness),loopFlag:o(this.rawData,l(this,y)+1,1,this.endianness),numberChannels:e,sampleRate:o(this.rawData,l(this,y)+4,2,this.endianness),loopStartSample:o(this.rawData,l(this,y)+8,4,this.endianness),totalSamples:o(this.rawData,l(this,y)+12,4,this.endianness),totalBlocks:o(this.rawData,l(this,y)+20,4,this.endianness),blockSize:o(this.rawData,l(this,y)+24,4,this.endianness),samplesPerBlock:o(this.rawData,l(this,y)+28,4,this.endianness),finalBlockSize:o(this.rawData,l(this,y)+32,4,this.endianness),finalBlockSizeWithPadding:o(this.rawData,l(this,y)+40,4,this.endianness),totalSamplesInFinalBlock:o(this.rawData,l(this,y)+36,4,this.endianness),adpcTableSamplesPerEntry:o(this.rawData,l(this,y)+44,4,this.endianness),adpcTableBytesPerEntry:o(this.rawData,l(this,y)+48,4,this.endianness),numberTracks:s,trackDescriptionType:r,trackDescriptions:a};return c.loopStartSample>=c.totalSamples&&(c.loopFlag=0,c.loopStartSample=0,console.warn("The loop start sample in this file is invalid.")),c},wt=function(e){const{blockSize:s,totalBlocks:r,numberChannels:a,finalBlockSize:c,finalBlockSizeWithPadding:n}=this.metadata,h=[];for(let i=0;i<a;i++)h.push(new Uint8Array(e===r-1?c:s));let f=e;for(let i=0;i<a;i++){const u=i!==0&&f+1===r?f*a*s+i*n:(f*a+i)*s,p=f+1===r?u+c:u+s,d=this.rawData.slice(l(this,N)+32+u,l(this,N)+32+p);h[i].set(d)}return h},yt=function(){if(l(this,_))return l(this,_);const{totalBlocks:e,numberChannels:s}=this.metadata,r=o(this.rawData,l(this,M)+4,4,this.endianness),a=this.rawData.slice(l(this,M)+8,l(this,M)+8+r);let c=0,n=0,h=0;for(let u=0;u<s;u++)n=x(o(a,c,2,this.endianness)),c+=2,h=x(o(a,c,2,this.endianness)),c+=2;const f=[];for(let u=0;u<e;u++){f.push([]);for(let p=0;p<s;p++)u>0&&(n=x(o(a,c,2,this.endianness)),c+=2,h=x(o(a,c,2,this.endianness)),c+=2),f[u].push({yn1:n,yn2:h})}let i=[];for(let u=0;u<s;u++)i.push(f.map(p=>p[u]));return I(this,_,i),i},rt=function(e){if(l(this,G)[e])return l(this,G)[e];const{numberChannels:s,totalBlocks:r,totalSamplesInFinalBlock:a,samplesPerBlock:c,codec:n}=this.metadata,h=L(this,b,mt).call(this),f=L(this,b,wt).call(this,e),i=L(this,b,yt).call(this),u=[],p=e===r-1?a:c;for(let d=0;d<s;d++)u.push(new Int16Array(p));for(let d=0;d<s;d++){const{adpcmCoefficients:g}=h[d],T=f[d],m=[];if(n===2){const D=T[0],{yn1:tt,yn2:_t}=i[d][e];let et=D,X=tt,ft=_t,st=0;for(let nt=0;nt<p;){let R=0;nt%14===0&&(et=T[st++]),nt++&1?R=T[st++]&15:R=T[st]>>4,R>=8&&(R-=16);const Wt=1<<(et&15),dt=et>>4<<1;R=1024+(Wt*R<<11)+g[Z(dt,0,15)]*X+g[Z(dt+1,0,15)]*ft>>11,ft=X,X=Z(R,-32768,32767),m.push(X)}e<r-1&&(i[d][e+1].yn1=m[p-1],i[d][e+1].yn2=m[p-2])}else if(n===1)for(let D=0;D<p;D++){const tt=x(o(T,D*2,2,this.endianness));m.push(tt)}else if(n===0)for(let D=0;D<p;D++)m.push(x(T[D])*256);else throw new Error("Invalid codec");u[d].set(m)}return l(this,G)[e]=u,u};let A=null;function Rt(t){A=new Mt(t)}function Lt(){A=null}function zt(){if(A)return A.metadata}function Ot(){if(!A)return;const t=A.getAllSamples();return K(t,t.map(e=>e.buffer))}function Ht(t,e){if(!A)return;const s=A.getSamples(t,e).map(Nt);return K(s,s.map(r=>r.buffer))}function Nt(t){const e=new Float32Array(t.length);for(let s=0;s<t.length;s++){const r=t[s];e[s]=r<0?r/32768:r/32767}return e}var Ft=Object.freeze({__proto__:null,destroy:Lt,getAllSamples:Ot,getMetadata:zt,getSamples:Ht,init:Rt});$(Ft)})();
